!function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}t="default"in t?t.default:t;var n=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),o=function(t,e){for(var n=0;n<t.length;n++)if(e(t[n]))return t[n]},r=function(t,e){return Object.keys(t).reduce(function(n,r){var i=!!o(e,function(t){return t._id===r}),a=t[r].status;return i?(a&&n[a].push(r),n):n},{understock:[],"re-stock":[],ok:[],overstock:[]})},i=function(t,e){return Object.keys(e).reduce(function(t,n){return t[n]=t[n]||0,e[n].allocation>0&&(t[n]+=e[n].allocation),t},t)},a=function(){function t(n,o,r,i,a,c,s,l,u){e(this,t),this.$q=n,this.smartId=o,this.STOCK_STATUSES=r,this.lgasService=i,this.statesService=a,this.zonesService=c,this.locationsService=s,this.thresholdsService=l,this.productListService=u}return n(t,[{key:"stateRequiredAllocationsByZone",value:function(t){var e=this;return t.reduce(function(t,n){if(n.location&&n.location.state&&!n.location.lga&&n.reStockNeeded){var o=e.smartId.idify({zone:n.location.zone},"locationId");t[o]=t[o]||{},t[o]=i(t[o],n.stock)}return t},{})}},{key:"decorateWithIndicators",value:function(t){var e=this,n=void 0,i=void 0,a=void 0,c=void 0,s=void 0,l=function(t,n,r,i){if(i.location){var a=e.smartId.idify(i.location,"locationId"),c=r;return i.location.state&&(c=i.location.lga?t:n),o(c,function(t){return t._id===a})}},u=function(t,r){var u=void 0;u=r.location.national?s:l(n,i,a,r);var d=void 0;d=u&&"zone"===u.level?e.thresholdsService.calculateThresholds(u,r,c,t[u._id]):e.thresholdsService.calculateThresholds(u,r,c);var v=r.stock,S=Object.keys(v).reduce(function(t,e){var n=v[e],r=void 0,i=void 0,a=void 0,s=o(c,function(t){return t._id===e});if(d&&(a=d[e])){r="overstock",n<a.min?r="understock":n<a.reOrder?r="re-stock":n<=a.max&&(r="ok");var l=a.max-n;if(i=l,s){var u=l%s.presentation;i=u>0?l+(s.presentation-u):l}}return t[e]={status:r,amount:n,allocation:i,thresholds:a},t},{});return r.stock=S,r},d=function(t){var e=function(e,n){return t.stock[n].allocation>0&&(e+=t.stock[n].allocation),e};if(t.location&&t.location.lga){var n=r(t.stock,c);t.reStockNeeded=!!(n.understock.length+n["re-stock"].length)}else if(t.stock){var o=Object.keys(t.stock).reduce(e,0);t.reStockNeeded=o>0}return t},v=function(t){var n=r(t.stock,c),o=n.understock.length,i=Object.keys(n).reduce(function(t,e){return t+n[e].length},0);return t.stockLevelStatus="unknown",t.location&&(o>=e.STOCK_STATUSES.alert.threshold?t.stockLevelStatus=e.STOCK_STATUSES.alert.id:o>=e.STOCK_STATUSES.warning.threshold?t.stockLevelStatus=e.STOCK_STATUSES.warning.id:i>0&&(t.stockLevelStatus=e.STOCK_STATUSES.ok.id)),t},S=function(t){return t.stock&&Object.keys(t.stock).length},h=function(t){return t.location&&t.location.zone&&!t.location.state},f=function(t){return!h(t)},k=function(t){return t.location&&t.location.national},g=function(t,o,r){return n=r.lgas,i=r.states,a=r.zones||[],c=r.products,s=r.national||[],t=t.map(u.bind(null,null)).map(d),o=o.map(u.bind(null,e.stateRequiredAllocationsByZone(t))).map(d),t.concat(o).map(v)},T={lgas:this.lgasService.list(),states:this.statesService.list(),products:this.productListService.relevant()};if(t=t.filter(S),!t.length)return this.$q.when(t);var m=t.filter(h),p=t.filter(f),y=t.filter(k);return m.length&&(T.zones=this.zonesService.list()),y.length&&(T.national=this.locationsService.get("national")),this.$q.all(T).then(g.bind(null,p,m))}}]),t}();a.$inject=["$q","smartId","STOCK_STATUSES","lgasService","statesService","zonesService","locationsService","thresholdsService","productListService"],t.module("angularNavStateIndicators",["ngSmartId","angularNavData","angularNavThresholds"]).service("stateIndicatorsService",a)}(angular);