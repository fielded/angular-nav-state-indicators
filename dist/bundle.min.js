!function(t){"use strict";t="default"in t?t.default:t;var e=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}();var n=function(t,e){for(var n=0;n<t.length;n++)if(e(t[n]))return t[n]},o=function(t,e){return Object.keys(t).reduce(function(o,r){var i=!!n(e,function(t){return t._id===r}),a=t[r].status;return i?(a&&o[a].push(r),o):o},{understock:[],"re-stock":[],ok:[],overstock:[]})},r=function(){function t(e,n,o,r,i,a,c,s,l){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.$q=e,this.smartId=n,this.STOCK_STATUSES=o,this.lgasService=r,this.statesService=i,this.zonesService=a,this.locationsService=c,this.thresholdsService=s,this.productListService=l}return e(t,[{key:"stateRequiredAllocationsByZone",value:function(t){var e=this;return t.reduce(function(t,n){if(n.location&&n.location.state&&!n.location.lga&&n.reStockNeeded){var o=e.smartId.idify({zone:n.location.zone},"locationId");t[o]=t[o]||{},t[o]=(r=t[o],i=n.stock,Object.keys(i).reduce(function(t,e){return t[e]=t[e]||0,i[e].allocation>0&&(t[e]+=i[e].allocation),t},r))}var r,i;return t},{})}},{key:"decorateWithIndicators",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0,a=void 0,c=void 0,s=void 0,l=void 0,u=function(t,o){var r=void 0;r=t.location.national?l:function(t,o,r,i){if(i.location){var a=e.smartId.idify(i.location,"locationId"),c=r;return i.location.state&&(c=i.location.lga?t:o),n(c,function(t){return t._id===a})}}(i,a,c,t);var u=void 0;u=r&&"zone"===r.level&&o?e.thresholdsService.calculateThresholds(r,t,s,o[r._id]):e.thresholdsService.calculateThresholds(r,t,s);var d=t.stock,v=Object.keys(d).reduce(function(t,e){var o=d[e],r=void 0,i=void 0,a=void 0,c=n(s,function(t){return t._id===e});if(u&&(a=u[e])){r="overstock",o<a.min?r="understock":o<a.reOrder?r="re-stock":o<=a.max&&(r="ok");var l=a.max-o;if(i=l,c){var v=l%c.presentation;i=v>0?l+(c.presentation-v):l}}return t[e]={status:r,amount:o,allocation:i,thresholds:a},t},{});return t.stock=v,t},d=function(t){if(t.location&&t.location.lga){var e=o(t.stock,s);t.reStockNeeded=!!(e.understock.length+e["re-stock"].length)}else if(t.stock){var n=Object.keys(t.stock).reduce(function(e,n){return t.stock[n].allocation>0&&(e+=t.stock[n].allocation),e},0);t.reStockNeeded=n>0}return t},v=function(t){var n=o(t.stock,s),r=n.understock.length,i=Object.keys(n).reduce(function(t,e){return t+n[e].length},0);return t.stockLevelStatus="unknown",t.location&&(r>=e.STOCK_STATUSES.alert.threshold?t.stockLevelStatus=e.STOCK_STATUSES.alert.id:r>=e.STOCK_STATUSES.warning.threshold?t.stockLevelStatus=e.STOCK_STATUSES.warning.id:i>0&&(t.stockLevelStatus=e.STOCK_STATUSES.ok.id)),t},S=function(t){return t.location&&t.location.zone&&!t.location.state},h={lgas:this.lgasService.list(),states:this.statesService.list(),products:this.productListService.relevant()};if(!(t=t.filter(function(t){return t.stock&&Object.keys(t.stock).length})).length)return this.$q.when(t);var f=t.filter(S),k=t.filter(function(t){return!S(t)}),g=t.filter(function(t){return t.location&&t.location.national});return f.length&&(h.zones=this.zonesService.list()),g.length&&(h.national=this.locationsService.get("national")),this.$q.all(h).then(function(t,n,o){return i=o.lgas,a=o.states,c=o.zones||[],s=o.products,l=o.national||{},t=t.map(function(t){return u(t)}).map(d),n=n.map(function(n){return!1===r.requireChildAllocations?u(n):u(n,e.stateRequiredAllocationsByZone(t))}).map(d),t.concat(n).map(v)}.bind(null,k,f))}}]),t}();r.$inject=["$q","smartId","STOCK_STATUSES","lgasService","statesService","zonesService","locationsService","thresholdsService","productListService"],t.module("angularNavStateIndicators",["ngSmartId","angularNavData","angularNavThresholds"]).service("stateIndicatorsService",r)}(angular);