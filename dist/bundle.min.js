!function(t){"use strict";t="default"in t?t["default"]:t;var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=function(t,e){for(var n=0;n<t.length;n++)if(e(t[n]))return t[n];return void 0},i=function(t,e){return Object.keys(t).reduce(function(n,r){var i=!!o(e,function(t){return t._id===r}),c=t[r].status;return i?(c&&n[c].push(r),n):n},{understock:[],"re-stock":[],ok:[],overstock:[]})},c=function(t,e){return Object.keys(e).reduce(function(t,n){return t[n]=t[n]||0,e[n].allocation>0&&(t[n]+=e[n].allocation),t},t)},a=function(){function t(e,r,o,i,c,a,s,u){n(this,t),this.$q=e,this.smartId=r,this.STOCK_STATUSES=o,this.lgasService=i,this.statesService=c,this.zonesService=a,this.thresholdsService=s,this.productListService=u}return r(t,[{key:"stateRequiredAllocationsByZone",value:function(t){var e=this;return t.reduce(function(t,n){if(n.location&&n.location.state&&!n.location.lga&&n.reStockNeeded){var r=e.smartId.idify({zone:n.location.zone},"locationId");t[r]=t[r]||{},t[r]=c(t[r],n.stock)}return t},{})}},{key:"decorateWithIndicators",value:function(t){var n=this,r=void 0,c=void 0,a=void 0,s=void 0,u=function(t,n,r,i){var c=i.location.lga,a=i.location.state;if(c)return o(t,function(t){return t.id===c});if(a)return o(n,function(t){return t.id===a});var s=function(){var t=i.location.zone;return{v:o(r,function(e){return e.id===t})}}();return"object"===("undefined"==typeof s?"undefined":e(s))?s.v:void 0},l=function(t,e){var i=u(r,c,a,e),l=void 0;l=i&&"zone"===i.level?n.thresholdsService.calculateThresholds(i,e,s,t[i._id],{version:"last"}):n.thresholdsService.calculateThresholds(i,e,s);var d=e.stock,f=Object.keys(d).reduce(function(t,e){var n=d[e],r=void 0,i=void 0,c=void 0,a=o(s,function(t){return t._id===e});if(l&&(c=l[e])){r="overstock",n<c.min?r="understock":n<c.reOrder?r="re-stock":n<=c.max&&(r="ok");var u=c.max-n;if(i=u,a){var f=u%a.presentation;i=f>0?u+(a.presentation-f):u}}return t[e]={status:r,amount:n,allocation:i,thresholds:c},t},{});return e.stock=f,e},d=function(t){var e=function(e,n){return t.stock[n].allocation>0&&(e+=t.stock[n].allocation),e};if(t.location&&t.location.lga){var n=i(t.stock,s);t.reStockNeeded=!!(n.understock.length+n["re-stock"].length)}else if(t.stock){var r=Object.keys(t.stock).reduce(e,0);t.reStockNeeded=r>0}return t},f=function(t){var e=i(t.stock,s),r=e.understock.length,o=Object.keys(e).reduce(function(t,n){return t+e[n].length},0);return t.stockLevelStatus="unknown",t.location&&(r>=n.STOCK_STATUSES.alert.threshold?t.stockLevelStatus=n.STOCK_STATUSES.alert.id:r>=n.STOCK_STATUSES.warning.threshold?t.stockLevelStatus=n.STOCK_STATUSES.warning.id:o>0&&(t.stockLevelStatus=n.STOCK_STATUSES.ok.id)),t},v=function(t){return t.stock&&Object.keys(t.stock).length},S=function(t){return t.location&&t.location.zone&&!t.location.state},h=function(t){return!S(t)},k=function(t,e,o){return r=o.lgas,c=o.states,a=o.zones||[],s=o.products,t=t.map(l.bind(null,null)).map(d),e=e.map(l.bind(null,n.stateRequiredAllocationsByZone(t))).map(d),t.concat(e).map(f)},y={lgas:this.lgasService.list(),states:this.statesService.list(),products:this.productListService.relevant()};if(t=t.filter(v),!t.length)return this.$q.when(t);var g=t.filter(S),T=t.filter(h);return g.length&&(y.zones=this.zonesService.list()),this.$q.all(y).then(k.bind(null,T,g))}}]),t}();a.$inject=["$q","smartId","STOCK_STATUSES","lgasService","statesService","zonesService","thresholdsService","productListService"],t.module("angularNavStateIndicators",["ngSmartId","angularNavData","angularNavThresholds"]).service("stateIndicatorsService",a)}(angular);