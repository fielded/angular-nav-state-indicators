!function(e){"use strict";e="default"in e?e.default:e,!function(e){function t(e,t){return t={exports:{}},e(t,t.exports),t.exports}e="default"in e?e.default:e,!function(e){e="default"in e?e.default:e;var t={};t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}();var n=function(e,t){var n=function(e){var t={key:e,isOptional:!1},n=e.split("?");return""===n[0]&&(t.key=n[1],t.isOptional=!0),t};return e.split(t).map(n)},a=function(){function e(n){t.classCallCheck(this,e);try{this.separator=n.get("ngSmartIdSeparator")}catch(e){this.separator=":"}try{this.patterns=n.get("ngSmartIdPatterns")}catch(e){this.patterns={}}}return t.createClass(e,[{key:"parse",value:function(e,t){var a=e.split(this.separator),r=void 0,i=a.reduce(function(e,t){return r?(e[r]=t,r=void 0):r=t,e},{});if(t){t=this.patterns[t]||t;var o=n(t,this.separator);o.forEach(function(e){if(!i[e.key]&&!e.isOptional)throw new Error("could not parse the id, non optional field "+e.key+" missing")})}return i}},{key:"idify",value:function(e,t){var a=this,r=function(e){return"undefined"!=typeof e&&null!==e&&""!==e};t=this.patterns[t]||t;var i=n(t,this.separator);return i.reduce(function(t,n){var i=e[n.key];if(i&&r(i))return t+(t.length?a.separator+n.key:n.key)+a.separator+i;if(!n.isOptional)throw new Error("could not generate id, missing field "+n.key);return t},"")}}]),e}();a.$inject=["$injector"],e.module("ngSmartId",[]).service("smartId",a)}(angular);var n=(t(function(e,t){"undefined"!=typeof e&&"undefined"!=typeof t&&e.exports===t&&(e.exports="pouchdb"),function(e,t,n){t.module("pouchdb",[]).constant("POUCHDB_METHODS",{destroy:"qify",put:"qify",post:"qify",get:"qify",remove:"qify",bulkDocs:"qify",bulkGet:"qify",allDocs:"qify",putAttachment:"qify",getAttachment:"qify",removeAttachment:"qify",query:"qify",viewCleanup:"qify",info:"qify",compact:"qify",revsDiff:"qify",changes:"eventEmitter",sync:"eventEmitter",replicate:{to:"eventEmitter",from:"eventEmitter"}}).service("pouchDBDecorators",["$q",function(e){this.qify=function(t){return function(){return e.when(t.apply(this,arguments))}},this.eventEmitter=function(t){return function(){var n=e.defer(),a=t.apply(this,arguments).on("change",function(e){return n.notify({change:e})}).on("paused",function(e){return n.notify({paused:e})}).on("active",function(e){return n.notify({active:e})}).on("denied",function(e){return n.notify({denied:e})}).on("complete",function(e){return n.resolve(e)}).on("error",function(e){return n.reject(e)});return a.$promise=n.promise,a}}}]).provider("pouchDB",["POUCHDB_METHODS",function(e){var n=this;n.methods=e,n.$get=["$window","pouchDBDecorators",function(e,a){function r(e,n,i){for(var o in n){var s=n[o];t.isString(s)?(s=a[s],i?e[i][o]=s(e[i][o]):e[o]=s(e[o])):r(e,s,o)}return e}return function(t,a){var i=new e.PouchDB(t,a);return r(i,n.methods)}}]}])}(window,window.angular)}),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(e,t){e.then(t)},i=function(){function e(t,a,r){n(this,e);var i=void 0;try{i=t.get("dataModuleRemoteDB")}catch(e){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=a,this.angularNavDataUtilsService=r,this.remoteDB=this.pouchDB(i),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return a(e,[{key:"startReplication",value:function(e,t){var n={filter:"locations/by-state",query_params:{zone:e,state:t}};for(this.localDB=this.pouchDB("navIntLocationsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,n);this.callbacksPendingRegistration.length;){var a=this.callbacksPendingRegistration.shift();r(this.replicationFrom,a)}}},{key:"callOnReplicationComplete",value:function(e,t){-1===this.registeredOnReplicationCompleteCallbackIds.indexOf(e)&&(this.registeredOnReplicationCompleteCallbackIds.push(e),this.replicationFrom?r(this.replicationFrom,t):this.callbacksPendingRegistration.push(t))}},{key:"allDocs",value:function(e){var t=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(t,e)}},{key:"query",value:function(e,t){var n=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.query(n,e,t)}},{key:"get",value:function(e){var t=this.localDB||this.remoteDB;return t.get(e)}}]),e}();i.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var o=function(){function e(t,a,r,i,o,s){n(this,e),this.cachedLgasByState={},this.defaultZone,this.defaultState,this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.smartId=a,this.locationsService=r,this.statesService=i,this.productListService=o,this.utils=s;var c=this.bustCache.bind(this);this.locationsService.callOnReplicationComplete("lgas-service",c)}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"bustCache",value:function(){this.byState({bustCache:!0}),this.setDefaultStateRelevantProducts()}},{key:"setDefaultStateRelevantProducts",value:function(){var e=this,t=function(t){e.productListService.setRelevant(t.products)},n="configuration:"+this.smartId.idify({zone:this.defaultZone,state:this.defaultState},"zone:state");this.locationsService.get(n).then(t)}},{key:"queryAndUpdateCache",value:function(e){var t=this,n=function(e){return e.id=t.smartId.parse(e._id).lga,e},a=function(e){var n={include_docs:!0,ascending:!0};return e.zone&&e.state?(n.startkey="zone:"+e.zone+":state:"+e.state+":",n.endkey="zone:"+e.zone+":state:"+e.state+":￿",t.locationsService.allDocs(n)):(n.key="lga",t.locationsService.query("locations/by-level",n))},r=function(e,a){var r=a.map(n);e?t.cachedLgasByState[e]=r:t.cachedLgasByState=r,t.utils.isIndexedCacheEmpty(t.cachedLgasByState,e)||t.utils.callEach(t.registeredOnCacheUpdatedCallbacks)};return a(e).then(r.bind(null,e.state))}},{key:"byState",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(e){return e.id},a=function(){var a=angular.copy(e.cachedLgasByState);return t.onlyIds&&Object.keys(a).forEach(function(e){a[e]=a[e].map(n)}),t.zone&&t.state&&(a=a[t.state]),t.asArray&&(a=e.utils.toArray(a)),a};return t.zone=t.zone||this.defaultZone,t.state=t.state||this.defaultState,t.bustCache||this.utils.isIndexedCacheEmpty(this.cachedLgasByState,t.state)?this.queryAndUpdateCache(t).then(a):this.$q.when(a())}},{key:"idsByState",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyIds=!0,this.byState(e)}},{key:"list",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.asArray=!0,this.byState(e)}},{key:"setState",value:function(e,t){this.defaultZone=e,this.defaultState=t,this.statesService.setZone(this.defaultZone),this.bustCache()}},{key:"get",value:function(e){var t=function(t){var n=!0,a=!1,r=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;if(s._id===e)return s}}catch(e){a=!0,r=e}finally{try{!n&&o.return&&o.return()}finally{if(a)throw r}}},n=this.smartId.parse(e).state,a=this.smartId.parse(e).zone;return this.byState({zone:a,state:n}).then(t)}}]),e}();o.$inject=["$q","smartId","locationsService","statesService","productListService","angularNavDataUtilsService"];var s=function(){function e(t,a,r,i){n(this,e),this.cachedStatesByZone={},this.defaultZone,this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.smartId=a,this.locationsService=r,this.utils=i;var o=this.byZone.bind(this,{bustCache:!0});this.locationsService.callOnReplicationComplete("states-service",o)}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"queryAndUpdateCache",value:function(e){var t=this,n=function(e){return e.id=t.smartId.parse(e._id).state,e},a=function(e){var n={include_docs:!0,ascending:!0};return e.zone?(n.startkey="zone:"+e.zone+":",n.endkey="zone:"+e.zone+":￿",t.locationsService.allDocs(n)):(n.key="state",t.locationsService.query("locations/by-level",n))},r=function(e,a){var r=a.map(n);e?t.cachedStatesByZone[e]=r:t.cachedStatesByZone=r,t.utils.isIndexedCacheEmpty(t.cachedStatesByZone,e)||t.utils.callEach(t.registeredOnCacheUpdatedCallbacks)};return a(e).then(r.bind(null,e.zone))}},{key:"byZone",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(e){return e.id},a=function(){var a=angular.copy(e.cachedStatesByZone);return t.onlyIds&&Object.keys(a).forEach(function(e){a[e]=a[e].map(n)}),t.zone&&(a=a[t.zone]),t.asArray&&(a=e.utils.toArray(a)),a};return t.zone=t.zone||this.defaultZone,t.bustCache||this.utils.isIndexedCacheEmpty(this.cachedStatesByZone,t.zone)?this.queryAndUpdateCache(t).then(a):this.$q.when(a())}},{key:"idsByZone",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyIds=!0,this.byZone(e)}},{key:"list",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.asArray=!0,this.byZone(e)}},{key:"setZone",value:function(e){this.defaultZone=e,this.byZone({bustCache:!0})}},{key:"get",value:function(e){var t=function(t){var n=!0,a=!1,r=void 0;try{for(var i,o=t[Symbol.iterator]();!(n=(i=o.next()).done);n=!0){var s=i.value;if(s._id===e)return s}}catch(e){a=!0,r=e}finally{try{!n&&o.return&&o.return()}finally{if(a)throw r}}},n=this.smartId.parse(e).zone;return this.byZone({zone:n}).then(t)}}]),e}();s.$inject=["$q","smartId","locationsService","angularNavDataUtilsService"];var c=function(e){return e.doc},l=function(e){return"undefined"!=typeof e},u=function(e){return e.rows.map(c).filter(l)},h=function(){function e(){n(this,e)}return a(e,[{key:"allDocs",value:function(e,t){return e.allDocs(t).then(u)}},{key:"query",value:function(e,t,n){return e.query(t,n).then(u)}},{key:"callEach",value:function(e){var t=function(t){return e[t]()};Object.keys(e).forEach(t)}},{key:"isEmptyObject",value:function(e){return!Object.keys(e).length}},{key:"isIndexedCacheEmpty",value:function(e,t){var n=this.isEmptyObject(e);return!n&&t?!e[t]||!e[t].length:n}},{key:"toArray",value:function(e){return Object.keys(e).reduce(function(t,n){return t.concat(e[n])},[])}}]),e}(),d="angularNavData.utils";e.module(d,[]).service("angularNavDataUtilsService",h);var f="angularNavData.locations";e.module(f,[d,"ngSmartId","pouchdb"]).service("locationsService",i).service("lgasService",o).service("statesService",s);var v=function(e,t){e.then(t)},y=function(){function e(t,a,r){n(this,e);var i=void 0;try{i=t.get("dataModuleRemoteDB")}catch(e){throw new Error("dataModuleRemoteDB should be provided in the data module configuration")}this.pouchDB=a,this.angularNavDataUtilsService=r,this.remoteDB=this.pouchDB(i),this.replicationFrom,this.localDB,this.registeredOnReplicationCompleteCallbackIds=[],this.callbacksPendingRegistration=[]}return a(e,[{key:"startReplication",value:function(e,t){var n={filter:"products/all"};for(this.localDB=this.pouchDB("navIntProductsDB"),this.replicationFrom=this.localDB.replicate.from(this.remoteDB,n);this.callbacksPendingRegistration.length;){var a=this.callbacksPendingRegistration.shift();v(this.replicationFrom,a)}}},{key:"callOnReplicationComplete",value:function(e,t){-1===this.registeredOnReplicationCompleteCallbackIds.indexOf(e)&&(this.registeredOnReplicationCompleteCallbackIds.push(e),this.replicationFrom?v(this.replicationFrom,t):this.callbacksPendingRegistration.push(t))}},{key:"allDocs",value:function(e){var t=this.localDB||this.remoteDB;return this.angularNavDataUtilsService.allDocs(t,e)}}]),e}();y.$inject=["$injector","pouchDB","angularNavDataUtilsService"];var p=function(){function e(t,a,r){n(this,e),this.cachedProducts=[],this.relevantIds=[],this.registeredOnCacheUpdatedCallbacks={},this.$q=t,this.productsService=a,this.utils=r;var i=this.relevant.bind(this,{bustCache:!0});this.productsService.callOnReplicationComplete("products-list-service",i)}return a(e,[{key:"registerOnCacheUpdatedCallback",value:function(e,t){this.registeredOnCacheUpdatedCallbacks[e]||(this.registeredOnCacheUpdatedCallbacks[e]=t)}},{key:"unregisterOnCacheUpdatedCallback",value:function(e){delete this.registeredOnCacheUpdatedCallbacks[e]}},{key:"queryAndUpdateCache",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(t){var n={include_docs:!0};if(t.onlyRelevant){if(!e.relevantIds.length)return e.$q.when([]);n.keys=e.relevantIds}else n.ascending=!0,n.startkey="product:",n.endkey="product:￿";return e.productsService.allDocs(n)},a=function(t){e.cachedProducts=t,e.cachedProducts.length&&e.utils.callEach(e.registeredOnCacheUpdatedCallbacks)};return n(t).then(a)}},{key:"relevant",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return e.onlyRelevant=!0,this.all(e)}},{key:"all",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=function(e,t){return t.storageType===e},a=function(){return t.byType?{dry:e.cachedProducts.filter(n.bind(null,"dry")),frozen:e.cachedProducts.filter(n.bind(null,"frozen"))}:e.cachedProducts};return this.cachedProducts.length&&!t.bustCache?this.$q.when(a()):this.queryAndUpdateCache(t).then(a)}},{key:"setRelevant",value:function(e){this.relevantIds=e,this.relevant({bustCache:!0})}}]),e}();p.$inject=["$q","productsService","angularNavDataUtilsService"];var g="angularNavData.products";e.module(g,[d,"pouchdb"]).service("productsService",y).service("productListService",p),e.module("angularNavData",[f,g])}(angular),!function(e){e="default"in e?e.default:e;var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),a=function(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return e[n]},r=function(e,t){return t.version===e},i=function(){function e(){t(this,e)}return n(e,[{key:"calculateThresholds",value:function(e,t){if(e&&e.allocations&&e.plans&&t&&t.allocations&&t.allocations.version&&t.plans&&t.plans.version){var n=a(e.allocations,r.bind(null,t.allocations.version)).weeklyLevels,i=a(e.plans,r.bind(null,t.plans.version)).weeksOfStock,o=Object.keys(n).reduce(function(e,t){return e[t]=Object.keys(i).reduce(function(e,a){return e[a]=Math.round(n[t]*i[a]),e},{}),e},{});return o}}}]),e}();e.module("angularNavThresholds",[]).service("thresholdsService",i)}(angular);var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),r=function(e,t){for(var n=0;n<e.length;n++)if(t(e[n]))return e[n]},i=function(e){return Object.keys(e).reduce(function(t,n){var a=e[n].status;return a&&t[a].push(n),t},{understock:[],"re-stock":[],ok:[],overstock:[]})},o=function(){function e(t,a,r,i,o){n(this,e),this.$q=t,this.STOCK_STATUSES=a,this.lgasService=r,this.statesService=i,this.thresholdsService=o}return a(e,[{key:"decorateWithIndicators",value:function(e){var n=this,a=void 0,o=void 0,s=function(e,n,a){var i=a.location.lga;if(i)return r(e,function(e){return e.id===i});var o=function(){var e=a.location.state;return{v:r(n,function(t){return t.id===e})}}();return"object"===("undefined"==typeof o?"undefined":t(o))?o.v:void 0},c=function(e){var t=s(a,o,e),r=n.thresholdsService.calculateThresholds(t,e),i=e.stock,c=Object.keys(i).reduce(function(e,t){var n=i[t],a=void 0,o=void 0;if(r){var s=r[t];s&&(a="overstock",n<=s.min?a="understock":n<=s.reOrder?a="re-stock":n<=s.max&&(a="ok"),o=s.max-n)}return e[t]={status:a,amount:n,allocation:o},e},{});return e.stock=c,e},l=function(e){var t=i(e.stock);return e.reStockNeeded=!!(t.understock.length+t["re-stock"].length),e},u=function(e){var t=i(e.stock).understock.length;return e.store&&"lga"===e.store.type&&(t>=n.STOCK_STATUSES.alert.threshold?e.stockLevelStatus=n.STOCK_STATUSES.alert.id:t>=n.STOCK_STATUSES.warning.threshold?e.stockLevelStatus=n.STOCK_STATUSES.warning.id:e.stockLevelStatus=n.STOCK_STATUSES.ok.id),e},h=function(t){return a=t.lgas,o=t.states,e.map(c).map(l).map(u)},d={lgas:this.lgasService.list(),states:this.statesService.list()};return this.$q.all(d).then(h)}}]),e}();o.$inject=["$q","STOCK_STATUSES","lgasService","statesService","thresholdsService"],e.module("angularNavStateIndicators",["angularNavData","angularNavThresholds"]).service("stateIndicatorsService",o)}(angular);